<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frozone Store</title>
  <link rel="stylesheet" href="style.css" />
  <script async src="https://js.stripe.com/v3/buy-button.js"></script>
  <style>
    /* [Truncated for brevity â€” same CSS as your original, no changes needed] */
  </style>
</head>
<body>
  <!-- [HTML Layout â€“ same as before, no change needed] -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app-check.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAveoEg2mxueUIezZfPlvnRj28JKZD13KE",
      authDomain: "frozo-3ba69.firebaseapp.com",
      projectId: "frozo-3ba69",
      storageBucket: "frozo-3ba69.appspot.com",
      messagingSenderId: "183765467189",
      appId: "1:183765467189:web:b7a47c91c2dbaca7c1717c"
    };

    const app = initializeApp(firebaseConfig);

    const appCheck = initializeAppCheck(app, {
      provider: new ReCaptchaV3Provider('6LeejGorAAAAABVrW3cng4Mt_7EVn5MtyHqtdoTK'),
      isTokenAutoRefreshEnabled: true
    });

    const db = getFirestore(app);

    // ðŸ”Œ Fetch the webhook from Firestore
    async function getOrderWebhookURL() {
      try {
        const docRef = doc(db, "config", "webhooks");
        const docSnap = await getDoc(docRef);
        return docSnap.exists() ? docSnap.data().orderWebhook : null;
      } catch (err) {
        console.error("Error fetching webhook URL:", err);
        return null;
      }
    }

    const categoryList = document.getElementById('category-list');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalProducts = document.getElementById('modal-products');
    const modalProductDetail = document.getElementById('modal-product-detail');
    const modalClose = document.getElementById('modal-close');
    const backToProductsBtn = document.getElementById('back-to-products');

    const detailName = document.getElementById('detail-name');
    const detailImage = document.getElementById('detail-image');
    const detailPrice = document.getElementById('detail-price');
    const detailStock = document.getElementById('detail-stock');
    const detailDescription = document.getElementById('detail-description');
    const addToCartBtn = document.getElementById('add-to-cart');

    const quantitySlider = document.getElementById('quantity-slider');
    const quantityDisplay = document.getElementById('quantity-display');

    const cartItemsDiv = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');
    const submitOrderBtn = document.getElementById('submit-order');
    const robloxInput = document.getElementById('roblox-username');

    const discountCodeInput = document.getElementById('discount-code');
    const applyDiscountBtn = document.getElementById('apply-discount');
    const discountMessage = document.getElementById('discount-message');

    const toggleCartBtn = document.getElementById('toggle-cart');
    const cartPanel = document.getElementById('cart');

    const startModal = document.getElementById('start-modal');
    const startShopBtn = document.getElementById('start-shop');

    let currentCategory = "";
    let currentProduct = null;
    let cart = [];
    let discountPercent = 0;
    let discountFixed = 0;

    function updateQuantityDisplay(value) {
      quantityDisplay.textContent = value;
    }
    quantitySlider.oninput = () => updateQuantityDisplay(quantitySlider.value);

    async function loadCategories() {
      const snap = await getDocs(collection(db, "categories"));
      categoryList.innerHTML = '';
      snap.forEach(docSnap => {
        const div = document.createElement('div');
        div.className = 'category-card';
        div.textContent = docSnap.id;
        div.onclick = () => openCategoryModal(docSnap.id);
        categoryList.appendChild(div);
      });
    }

    async function openCategoryModal(catId) {
      currentCategory = catId;
      modalTitle.textContent = catId;
      modalProducts.innerHTML = 'Loading...'; modalProducts.style.display = 'grid';
      modalProductDetail.style.display = 'none';

      const productsSnap = await getDocs(collection(db, "categories", catId, "products"));
      modalProducts.innerHTML = '';
      productsSnap.forEach(docSnap => {
        const data = docSnap.data(); data.id = docSnap.id;
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `<img src="${data.image}" alt="${data.name}" /><h4>${data.name}</h4><p>$${data.price}</p>`;
        card.onclick = () => showProductDetail(data);
        modalProducts.appendChild(card);
      });

      startModal.style.display = 'none';
      modal.style.display = 'block';
    }

    function showProductDetail(product) {
      currentProduct = product;
      modalTitle.textContent = product.name;
      detailName.textContent = product.name;
      detailImage.src = product.image;
      detailPrice.textContent = product.price;
      detailStock.textContent = product.stock ?? 'âˆž';
      detailDescription.textContent = product.description || '';
      const maxQty = (product.stock ?? 1000) > 0 ? (product.stock ?? 1000) : 1;
      quantitySlider.max = maxQty;
      quantitySlider.value = 1;
      updateQuantityDisplay(1);
      modalProducts.style.display = 'none';
      modalProductDetail.style.display = 'block';
    }

    addToCartBtn.onclick = () => {
      if (!currentProduct) return;
      const qty = Number(quantitySlider.value);
      const availableStock = currentProduct.stock;
      const existing = cart.find(item => item.id === currentProduct.id && item.category === currentCategory);

      if (availableStock !== undefined && availableStock <= 0) {
        alert("Sorry, this product is out of stock.");
        return;
      }
      if (existing && availableStock !== undefined && existing.quantity + qty > availableStock) {
        alert("You can't add more of this item, stock limit reached.");
        return;
      }

      if (existing) {
        existing.quantity += qty;
      } else {
        cart.push({ ...currentProduct, quantity: qty, category: currentCategory });
      }

      updateCartUI();
      modal.style.display = 'none';
    };

    function updateCartUI() {
      cartItemsDiv.innerHTML = cart.length
        ? cart.map(i => `<div>${i.name} x${i.quantity} - $${(i.quantity * i.price).toFixed(2)}</div>`).join('')
        : "<em>Your cart is empty.</em>";

      let total = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
      if (discountPercent) total *= (1 - discountPercent / 100);
      if (discountFixed) total -= discountFixed;
      cartTotal.textContent = total < 0 ? '0.00' : total.toFixed(2);
    }

    applyDiscountBtn.onclick = () => {
      const code = discountCodeInput.value.trim().toUpperCase();
      if (code === "FRZ10") {
        discountPercent = 10; discountFixed = 0;
        discountMessage.textContent = "10% discount applied!";
      } else if (code === "FRZ5") {
        discountFixed = 5; discountPercent = 0;
        discountMessage.textContent = "$5 discount applied!";
      } else {
        discountMessage.textContent = "Invalid discount code.";
        discountPercent = discountFixed = 0;
      }
      updateCartUI();
    };

    submitOrderBtn.onclick = async () => {
      if (!cart.length) return alert("Your cart is empty.");
      if (!robloxInput.value.trim()) return alert("Please enter your Roblox username.");

      const order = {
        username: robloxInput.value.trim(),
        cart,
        total: Number(cartTotal.textContent),
        date: new Date().toISOString()
      };

      try {
        for (const item of cart) {
          if (item.stock != null) {
            const productRef = doc(db, "categories", item.category, "products", item.id);
            const newStock = item.stock - item.quantity;
            if (newStock < 0) throw new Error("Stock error");
            await updateDoc(productRef, { stock: newStock });
          }
        }

        const webhookURL = await getOrderWebhookURL();
        if (!webhookURL) throw new Error("Webhook URL not found.");

        await fetch(webhookURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            content: `New order from **${order.username}**\nItems:\n${order.cart.map(i => `- ${i.name} x${i.quantity} ($${(i.price*i.quantity).toFixed(2)}) [${i.category}]`).join('\n')}\nTotal: $${order.total.toFixed(2)}`
          })
        });

        alert("Order submitted successfully!");
        cart = []; updateCartUI();
        robloxInput.value = "";
        discountCodeInput.value = ""; discountMessage.textContent = "";
        discountPercent = discountFixed = 0;
        cartPanel.classList.remove('open');
      } catch (err) {
        alert("Error submitting order: " + err.message);
      }
    };

    modalClose.onclick = () => modal.style.display = 'none';
    backToProductsBtn.onclick = () => {
      modalTitle.textContent = currentCategory;
      modalProducts.style.display = 'grid';
      modalProductDetail.style.display = 'none';
    };

    window.onclick = event => {
      if (event.target === modal) modal.style.display = 'none';
    };

    toggleCartBtn.onclick = () => cartPanel.classList.toggle('open');

    startShopBtn.onclick = () => {
      document.getElementById('bg-music').play().catch(() => console.warn('Music fail'));
      startModal.style.display = 'none';
      modalProducts.style.display = 'grid';
      modalTitle.textContent = "Categories";
      modal.style.display = 'none';
    };

    window.onload = async () => {
      await loadCategories();
      modal.style.display = 'block';
      startModal.style.display = 'block';
      modalProducts.style.display = 'none';
      modalProductDetail.style.display = 'none';
      modalTitle.textContent = "Welcome";
    };
  </script>
</body>
</html>
