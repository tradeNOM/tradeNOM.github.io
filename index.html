<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frozone Store</title>
  <script async src="https://js.stripe.com/v3/buy-button.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; color: white; background: #000b19; }
    header { text-align: center; padding: 20px; position: relative; }
    .category-card, .product-card {
      background: #111; margin: 10px; padding: 10px; cursor: pointer;
      border-radius: 8px; text-align: center;
      transition: background 0.3s ease;
    }
    .category-card:hover, .product-card:hover { background: #222; }
    .product-card img { max-width: 100px; }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100vw;
      height: 100vh; background: rgba(0,0,0,0.9); overflow: auto; z-index: 10;
    }
    .modal-content {
      margin: 5% auto; padding: 20px; width: 90%; max-width: 600px;
      background: #111; border-radius: 8px; color: white;
      position: relative;
    }
    .close {
      float: right; font-size: 28px; cursor: pointer; user-select:none;
      color: white; transition: color 0.3s ease;
    }
    .close:hover { color: #f00; }
    .cart-panel {
      position: fixed; top: 100px; right: -320px;
      width: 320px; background: #111; color: white; padding: 15px;
      border-left: 2px solid #444; z-index: 1000;
      box-shadow: -5px 0 15px rgba(0,0,0,0.7);
      transition: right 0.3s ease;
      border-radius: 8px 0 0 8px;
      max-height: 80vh; overflow-y: auto;
    }
    .cart-panel.open { right: 0; }
    .cart-panel input, .cart-panel button {
      width: 100%; padding: 10px; margin-top: 10px; border-radius: 5px;
      border: none; outline: none;
      font-size: 16px;
    }
    .cart-panel input { background: #222; color: white; }
    .cart-panel button {
      background: #0055ff; color: white; cursor: pointer;
      font-weight: 600; transition: background 0.3s ease;
    }
    .cart-panel button:hover { background: #003bb5; }
    #close-cart {
      cursor:pointer; float:right; font-size: 24px; user-select:none; color: white;
      transition: color 0.3s ease;
    }
    #close-cart:hover { color: #f00; }
    .modal-products {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;
    }
    #start-modal {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 20;
      flex-direction: column;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #start-modal button {
      background-color: #0055ff;
      border: none;
      border-radius: 8px;
      color: white;
      padding: 15px 30px;
      font-size: 18px;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s ease;
    }
    #start-modal button:hover { background-color: #003bb5; }
    #toggle-cart-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 28px;
      cursor: pointer;
      color: white;
      user-select: none;
      z-index: 1100;
      transition: color 0.3s ease;
    }
    #toggle-cart-btn:hover { color: #0055ff; }
  </style>
</head>
<body>
  <header>
    <h1>Frozone Store</h1>
    <h3>Your #1 Source for Axes</h3>
  </header>

  <div id="toggle-cart-btn" title="Toggle Cart">üõí</div>

  <section class="categories" id="category-list"></section>

  <div class="cart-panel" id="cart">
    <h2>
      üõí Your Cart
      <span id="close-cart">&times;</span>
    </h2>
    <div id="cart-items"></div>
    <input type="text" id="discount-code" placeholder="Discount Code" />
    <button id="apply-discount">Apply Discount</button>
    <p id="discount-message" style="color: lightgreen; margin-top: 5px;"></p>
    <p>Total: <strong id="cart-total">0</strong></p>
    <input type="text" id="roblox-username" placeholder="Your Roblox Username" required />
    <button id="submit-order">Submit Order</button>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span id="modal-close" class="close">&times;</span>
      <h2 id="modal-title"></h2>
      <div id="modal-products" class="modal-products"></div>
      <div id="modal-product-detail" style="display:none;">
        <button id="back-to-products">‚Üê Back to products</button>
        <h3 id="detail-name"></h3>
        <img id="detail-image" src="" alt="" style="max-width:100%;" />
        <p><strong>Price:</strong> $<span id="detail-price"></span></p>
        <p><strong>Stock:</strong> <span id="detail-stock"></span></p>
        <p id="detail-description"></p>
        <label for="quantity-slider"><strong>Quantity:</strong></label>
        <input type="range" id="quantity-slider" min="1" max="1" value="1" />
        <span id="quantity-value">1</span>
        <button id="add-to-cart">Add to Cart</button>
      </div>
    </div>
  </div>

  <!-- Start modal -->
  <div id="start-modal">
    <h1>Welcome to Frozone Store</h1>
    <button id="start-shop-btn">Shop</button>
  </div>

  <!-- Background audio (hidden controls) -->
  <audio id="bg-music" src="bg.mp3" loop></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAveoEg2mxueUIezZfPlvnRj28JKZD13KE",
      authDomain: "frozo-3ba69.firebaseapp.com",
      projectId: "frozo-3ba69",
      storageBucket: "frozo-3ba69.appspot.com",
      messagingSenderId: "183765467189",
      appId: "1:183765467189:web:b7a47c91c2dbaca7c1717c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const categoryList = document.getElementById('category-list');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalProducts = document.getElementById('modal-products');
    const modalProductDetail = document.getElementById('modal-product-detail');
    const modalClose = document.getElementById('modal-close');
    const backToProductsBtn = document.getElementById('back-to-products');

    const detailName = document.getElementById('detail-name');
    const detailImage = document.getElementById('detail-image');
    const detailPrice = document.getElementById('detail-price');
    const detailStock = document.getElementById('detail-stock');
    const detailDescription = document.getElementById('detail-description');
    const quantitySlider = document.getElementById('quantity-slider');
    const quantityValue = document.getElementById('quantity-value');
    const addToCartBtn = document.getElementById('add-to-cart');

    const cartPanel = document.getElementById('cart');
    const cartItemsDiv = document.getElementById('cart-items');
    const discountInput = document.getElementById('discount-code');
    const applyDiscountBtn = document.getElementById('apply-discount');
    const discountMessage = document.getElementById('discount-message');
    const cartTotalSpan = document.getElementById('cart-total');
    const robloxUsernameInput = document.getElementById('roblox-username');
    const submitOrderBtn = document.getElementById('submit-order');
    const closeCartBtn = document.getElementById('close-cart');
    const toggleCartBtn = document.getElementById('toggle-cart-btn');

    const startModal = document.getElementById('start-modal');
    const startShopBtn = document.getElementById('start-shop-btn');
    const bgMusic = document.getElementById('bg-music');

    let categories = [];
    let products = [];
    let currentCategory = null;
    let currentProduct = null;
    let cart = [];
    let discountPercent = 0;

    // Load categories from Firestore
    async function loadCategories() {
      const querySnapshot = await getDocs(collection(db, "Categories"));
      categories = [];
      querySnapshot.forEach(doc => {
        categories.push({ id: doc.id, ...doc.data() });
      });
      renderCategories();
    }

    // Load products for a category
    async function loadProducts(categoryId) {
      const querySnapshot = await getDocs(collection(db, "Products"));
      products = [];
      querySnapshot.forEach(doc => {
        const p = { id: doc.id, ...doc.data() };
        if (p.category === categoryId) products.push(p);
      });
      renderProducts();
    }

    function renderCategories() {
      categoryList.innerHTML = '';
      categories.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'category-card';
        div.textContent = cat.name;
        div.onclick = () => {
          currentCategory = cat;
          modalTitle.textContent = cat.name;
          modalProducts.style.display = 'grid';
          modalProductDetail.style.display = 'none';
          loadProducts(cat.id);
          modal.style.display = 'block';
        };
        categoryList.appendChild(div);
      });
    }

    function renderProducts() {
      modalProducts.innerHTML = '';
      products.forEach(prod => {
        const div = document.createElement('div');
        div.className = 'product-card';
        div.innerHTML = `<img src="${prod.image}" alt="${prod.name}" /><br>${prod.name}`;
        div.onclick = () => {
          currentProduct = prod;
          showProductDetail(prod);
        };
        modalProducts.appendChild(div);
      });
    }

    function showProductDetail(product) {
      modalProducts.style.display = 'none';
      modalProductDetail.style.display = 'block';

      detailName.textContent = product.name;
      detailImage.src = product.image;
      detailPrice.textContent = product.price.toFixed(2);
      detailStock.textContent = product.stock;
      detailDescription.textContent = product.description || "No description";
      quantitySlider.max = product.stock > 0 ? product.stock : 1;
      quantitySlider.value = 1;
      quantityValue.textContent = "1";
    }

    quantitySlider.addEventListener('input', () => {
      quantityValue.textContent = quantitySlider.value;
    });

    addToCartBtn.addEventListener('click', () => {
      const qty = parseInt(quantitySlider.value);
      if (qty > currentProduct.stock) {
        alert('Not enough stock.');
        return;
      }
      const cartItem = cart.find(i => i.id === currentProduct.id);
      if (cartItem) {
        if (cartItem.quantity + qty > currentProduct.stock) {
          alert('Not enough stock.');
          return;
        }
        cartItem.quantity += qty;
      } else {
        cart.push({
          id: currentProduct.id,
          name: currentProduct.name,
          price: currentProduct.price,
          quantity: qty,
          category: currentCategory.name
        });
      }
      updateCartUI();
      modal.style.display = 'none';
    });

    function updateCartUI() {
      cartItemsDiv.innerHTML = '';
      let total = 0;
      cart.forEach(item => {
        total += item.price * item.quantity;
        const div = document.createElement('div');
        div.style.marginBottom = '10px';
        div.innerHTML = `<strong>${item.name}</strong> (${item.category}) x${item.quantity} - $${(item.price * item.quantity).toFixed(2)}`;
        cartItemsDiv.appendChild(div);
      });
      if (discountPercent > 0) {
        const discountAmount = total * (discountPercent / 100);
        total = total - discountAmount;
      }
      cartTotalSpan.textContent = total.toFixed(2);
    }

    applyDiscountBtn.addEventListener('click', () => {
      const code = discountInput.value.trim();
      if (!code) {
        discountPercent = 0;
        discountMessage.textContent = '';
        updateCartUI();
        return;
      }
      // Example: discount code "SAVE10" gives 10% off
      if (code.toUpperCase() === 'SAVE10') {
        discountPercent = 10;
        discountMessage.textContent = 'Discount code applied! 10% off.';
      } else {
        discountPercent = 0;
        discountMessage.textContent = 'Invalid discount code.';
      }
      updateCartUI();
    });

    submitOrderBtn.addEventListener('click', async () => {
      const username = robloxUsernameInput.value.trim();
      if (!username) {
        alert('Please enter your Roblox username.');
        return;
      }
      if (cart.length === 0) {
        alert('Your cart is empty.');
        return;
      }
      const webhookUrl = 'https://discord.com/api/webhooks/1141066463569275007/jIlp...'; // Your webhook here

      let messageContent = `New order from **${username}**:\n`;
      cart.forEach(item => {
        messageContent += `- ${item.name} (${item.category}) x${item.quantity} - $${(item.price * item.quantity).toFixed(2)}\n`;
      });
      messageContent += `Total: $${cartTotalSpan.textContent}`;

      try {
        await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: messageContent }),
        });
        alert('Order submitted! Thank you.');
        // Optionally update stock in Firestore here
        cart.length = 0;
        updateCartUI();
        robloxUsernameInput.value = '';
        discountInput.value = '';
        discountMessage.textContent = '';
      } catch (e) {
        alert('Error submitting order.');
        console.error(e);
      }
    });

    modalClose.onclick = () => { modal.style.display = 'none'; };
    backToProductsBtn.onclick = () => {
      modalProducts.style.display = 'grid';
      modalProductDetail.style.display = 'none';
    };

    // Cart toggle and close
    toggleCartBtn.onclick = () => {
      cartPanel.classList.toggle('open');
    };
    closeCartBtn.onclick = () => {
      cartPanel.classList.remove('open');
    };

    // Start modal and music
    startShopBtn.onclick = () => {
      startModal.style.display = 'none';
      bgMusic.volume = 0.1;
      bgMusic.play();
    };

    // Load categories on page load
    loadCategories();
  </script>
</body>
</html>
